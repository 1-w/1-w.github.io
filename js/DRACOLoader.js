import{BufferAttribute,BufferGeometry,FileLoader,Loader}from"./three.module.js";var DRACOLoader=function(e){Loader.call(this,e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}};DRACOLoader.prototype=Object.assign(Object.create(Loader.prototype),{constructor:DRACOLoader,setDecoderPath:function(e){return this.decoderPath=e,this},setDecoderConfig:function(e){return this.decoderConfig=e,this},setWorkerLimit:function(e){return this.workerLimit=e,this},setVerbosity:function(){},setDrawMode:function(){},setSkipDequantization:function(){},load:function(e,t,r,o){var a=new FileLoader(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,e=>{var r={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(e,r).then(t).catch(o)},r,o)},decodeDracoFile:function(e,t,r,o){var a={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:o||this.defaultAttributeTypes,useUniqueIDs:!!r};this.decodeGeometry(e,a).then(t)},decodeGeometry:function(e,t){for(var r in t.attributeTypes){var o=t.attributeTypes[r];void 0!==o.BYTES_PER_ELEMENT&&(t.attributeTypes[r]=o.name)}var a,i=JSON.stringify(t);if(DRACOLoader.taskCache.has(e)){var s=DRACOLoader.taskCache.get(e);if(s.key===i)return s.promise;if(0===e.byteLength)throw Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var n=this.workerNextTaskID++,d=e.byteLength,u=this._getWorker(n,d).then(r=>(a=r,new Promise((r,o)=>{a._callbacks[n]={resolve:r,reject:o},a.postMessage({type:"decode",id:n,taskConfig:t,buffer:e},[e])}))).then(e=>this._createGeometry(e.geometry));return u.catch(()=>!0).then(()=>{a&&n&&this._releaseTask(a,n)}),DRACOLoader.taskCache.set(e,{key:i,promise:u}),u},_createGeometry:function(e){var t=new BufferGeometry;e.index&&t.setIndex(new BufferAttribute(e.index.array,1));for(var r=0;r<e.attributes.length;r++){var o=e.attributes[r],a=o.name,i=o.array,s=o.itemSize;t.setAttribute(a,new BufferAttribute(i,s))}return t},_loadLibrary:function(e,t){var r=new FileLoader(this.manager);return r.setPath(this.decoderPath),r.setResponseType(t),r.setWithCredentials(this.withCredentials),new Promise((t,o)=>{r.load(e,t,void 0,o)})},preload:function(){return this._initDecoder(),this},_initDecoder:function(){if(this.decoderPending)return this.decoderPending;var e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(t=>{var r=t[0];e||(this.decoderConfig.wasmBinary=t[1]);var o=DRACOLoader.DRACOWorker.toString(),a=["/* draco decoder */",r,"\n/* worker */",o.substring(o.indexOf("{")+1,o.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([a]))}),this.decoderPending},_getWorker:function(e,t){return this._initDecoder().then(()=>{var r;return this.workerPool.length<this.workerLimit?((r=new Worker(this.workerSourceURL))._callbacks={},r._taskCosts={},r._taskLoad=0,r.postMessage({type:"init",decoderConfig:this.decoderConfig}),r.onmessage=function(e){var t=e.data;switch(t.type){case"decode":r._callbacks[t.id].resolve(t);break;case"error":r._callbacks[t.id].reject(t)}},this.workerPool.push(r)):this.workerPool.sort(function(e,t){return e._taskLoad>t._taskLoad?-1:1}),(r=this.workerPool[this.workerPool.length-1])._taskCosts[e]=t,r._taskLoad+=t,r})},_releaseTask:function(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]},debug:function(){},dispose:function(){for(var e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}),DRACOLoader.DRACOWorker=function(){function e(e,t,r,o,a,i){var s=i.num_components(),n=r.num_points()*s,d=n*a.BYTES_PER_ELEMENT,u=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,a),c=e._malloc(d);t.GetAttributeDataArrayForAllPoints(r,i,u,d,c);var f=new a(e.HEAPF32.buffer,c,n).slice();return e._free(c),{name:o,array:f,itemSize:s}}var t,r;onmessage=function(o){var a=o.data;switch(a.type){case"init":t=a.decoderConfig,r=new Promise(function(e){t.onModuleLoaded=function(t){e({draco:t})},DracoDecoderModule(t)});break;case"decode":var i=a.buffer,s=a.taskConfig;r.then(t=>{var r=t.draco,o=new r.Decoder,n=new r.DecoderBuffer;n.Init(new Int8Array(i),i.byteLength);try{var d=function(t,r,o,a){var i,s,n=a.attributeIDs,d=a.attributeTypes,u=r.GetEncodedGeometryType(o);if(u===t.TRIANGULAR_MESH)i=new t.Mesh,s=r.DecodeBufferToMesh(o,i);else{if(u!==t.POINT_CLOUD)throw Error("THREE.DRACOLoader: Unexpected geometry type.");i=new t.PointCloud,s=r.DecodeBufferToPointCloud(o,i)}if(!s.ok()||0===i.ptr)throw Error("THREE.DRACOLoader: Decoding failed: "+s.error_msg());var c={index:null,attributes:[]};for(var f in n){var h,l,y=self[d[f]];if(a.useUniqueIDs)l=n[f],h=r.GetAttributeByUniqueId(i,l);else{if(-1===(l=r.GetAttributeId(i,t[n[f]])))continue;h=r.GetAttribute(i,l)}c.attributes.push(e(t,r,i,f,y,h))}return u===t.TRIANGULAR_MESH&&(c.index=function(e,t,r){var o=3*r.num_faces(),a=4*o,i=e._malloc(a);t.GetTrianglesUInt32Array(r,a,i);var s=new Uint32Array(e.HEAPF32.buffer,i,o).slice();return e._free(i),{array:s,itemSize:1}}(t,r,i)),t.destroy(i),c}(r,o,n,s),u=d.attributes.map(e=>e.array.buffer);d.index&&u.push(d.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:d},u)}catch(e){self.postMessage({type:"error",id:a.id,error:e.message})}finally{r.destroy(n),r.destroy(o)}})}}},DRACOLoader.taskCache=new WeakMap,DRACOLoader.setDecoderPath=function(){},DRACOLoader.setDecoderConfig=function(){},DRACOLoader.releaseDecoderModule=function(){},DRACOLoader.getDecoderModule=function(){};export{DRACOLoader};